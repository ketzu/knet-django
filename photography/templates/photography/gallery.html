{% extends 'list_environment.html' %}

{% block list_title %}
    {{ title }}
{% endblock %}

{% block admin_sub_header %}
    {% if perms.Gallery.change_Gallery and perms.Image.add_Image %}
        <style type="text/css" scoped>
            .box__dragndrop,
            .box__uploading,
            .box__success,
            .box__error {
                display: none;
            }

            .box.has-advanced-upload {
                background-color: white;
                outline: 2px dashed black;
                outline-offset: -10px;
            }

            .box.has-advanced-upload .box__dragndrop {
                display: inline;
            }

            .box.is-dragover {
                background-color: grey;
            }
        </style>
        <form class="box" id="upload-box" method="post" action="" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="box__input">
                <input class="box__file input" type="file" name="files" id="file"
                       data-multiple-caption="{count} files selected" multiple accept="image/*"/>
                <label for="file"><strong>Choose a file</strong><span
                        class="box__dragndrop"> or drag it here</span>.</label>
                <button class="box__button button" type="submit" onclick="submit_pictures(this.form); return false;">Upload</button>
            </div>
        </form>
        <script>
            const isAdvancedUpload = function () {
                let div = document.createElement('div');
                return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
            }();
            const form = document.getElementById('upload-box');

            let droppedFiles = false;

            if (isAdvancedUpload) {
                form.classList.add('has-advanced-upload');

                form.addEventListener("drop", e => {
                    e.preventDefault();
                    e.stopPropagation();
                });

                "dragover dragenter".split(" ").forEach(s => {
                    form.addEventListener(s, e => {
                        form.classList.add('is-dragover');
                        e.preventDefault();
                        e.stopPropagation();
                    })
                });

                "dragleave dragend drop".split(" ").forEach(s => {
                    form.addEventListener(s, e => {
                        form.classList.remove('is-dragover');
                        e.preventDefault();
                        e.stopPropagation();
                    })
                });

                function submit_pictures(form) {
                    const csrftoken = document.querySelector("input[name='csrfmiddlewaretoken']").value;
                    for (let file of form.files.files) {
                        let fd = new FormData();
                        fd.append("image", file);
                        let xhttp = new XMLHttpRequest();
                        xhttp.open("POST", "{% url 'add_picture' slug %}", true);
                        xhttp.setRequestHeader("X-CSRFToken", csrftoken);
                        xhttp.send(fd);
                    }
                    return 0;
                }
            }
        </script>
    {% endif %}
{% endblock %}

{% block list_entries %}
    <div class="modal">
        <div class="modal-background" onclick="document.querySelector('.modal').classList.remove('is-active'); "></div>
        <div class="modal-content" style="width: inherit; display: flex; justify-content: center; align-items: center;">
            <img src="" style="max-height: 90%; max-width: 90%;">
        </div>
        <button class="modal-close is-large" aria-label="close"
                onclick="document.querySelector('.modal').classList.remove('is-active'); "></button>
    </div>
    <div class="container">
        <div style="display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: flex-start;">
            {% for image in object_list %}
                <div style="margin: 5px;">
                    <button class="button"
                            style="background: url({{ image.picture.thumbnail.url }}); height: 200px; width: {{ image.picture.thumbnail.width }}px; border: 0;"
                            onclick="document.querySelector('.modal img').src = '{{ image.picture.url }}';document.querySelector('.modal').classList.add('is-active');">
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}
